/*
 *  OAC Video Annotation Tool v0.1
 * 
 *  Developed as a plugin for the MITHGrid framework. 
 *  
 *  Date: Mon Nov 14 11:07:56 2011 -0500
 *  
 * Educational Community License, Version 2.0
 * 
 * Copyright 2011 University of Maryland. Licensed under the Educational
 * Community License, Version 2.0 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * 
 * http://www.osedu.org/licenses/ECL-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 */
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=OAC||{};MITHGrid.globalNamespace("OAC"),OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){c.Client.StreamingVideo.initApp=function(c,d){var e,f;e=b.Application.initApp("OAC.Client.StreamingVideo",c,a.extend(!0,{},d,{variables:{ActiveAnnotation:{is:"rw"}},dataViews:{drawspace:{dataStore:"canvas",types:["Rectangle","Ellipse"],label:"drawspace"}},viewSetup:'<div id="canvasSVG" class="canvas_svg"></div><div id="annoList" class="anno_list"></div>',presentations:{raphsvg:{type:b.Presentation.RaphaelCanvas,container:"#canvasSVG",dataView:"drawspace",lenses:{Rectangle:function(a,c,d,f){var g={id:f},h=d.getItem(f),i,j,k,l,m=h.active[0];j=h.x-h.w[0]/2,k=h.y-h.h[0]/2,i=c.canvas.rect(j,k,h.w[0],h.h[0]),i.attr({fill:"red",opacity:m?1:.5}),g.update=function(a){a.active[0]&&m===!1?(i.attr({opacity:1}).toFront(),m=!0,c.editBoundingBox.attachRendering(g),c.keyBoardListener.events.eventDelete.addListener(g.eventDeleteHandle)):a.active[0]===!1&&m===!0&&(i.attr({opacity:.5}).toBack(),m=!1,c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(g.eventDeleteHandle));try{a.x!==undefined&&a.y!==undefined&&a.w!==undefined&&a.y!==undefined&&g.shape.attr({x:a.x[0]-a.w[0]/2,y:a.y[0]-a.h[0]/2,width:a.w[0],height:a.h[0]})}catch(b){console.log(b)}},g.remove=function(a){i.remove(),c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(g.eventDeleteHandle)},g.getExtents=function(){return{x:i.attr("x")+i.attr("width")/2,y:i.attr("y")+i.attr("height")/2,width:i.attr("width"),height:i.attr("height")}},g.shapeIsActive=b.initEventFirer(!1,!1),g.eventClickHandle=function(a){a===f?d.updateItems([{id:f,active:!0}]):d.updateItems([{id:f,active:!1}])},g.eventResizeHandle=function(a,b){a===f&&d.updateItems([{id:f,w:b.width,h:b.height}])},g.eventMoveHandle=function(a,b){a===f&&d.updateItems([{id:f,x:b.x,y:b.y}])},g.eventDeleteHandle=function(a){a===f&&d.removeItems([f])},g.shape=i,c.canvasEvents.registerRendering(g),e.events.onActiveAnnotationChange.addListener(g.eventClickHandle);return g},Ellipse:function(a,c,d,f){var g={id:f},h=d.getItem(f),i,j=h.active[0];i=c.canvas.ellipse(h.x[0],h.y[0],h.w[0]/2,h.h[0]/2),i.attr({fill:"red",opacity:j?1:.5}),g.update=function(a){a.active[0]&&j===!1?(i.attr({opacity:1}).toFront(),j=!0,c.editBoundingBox.attachRendering(g),c.keyBoardListener.events.eventDelete.addListener(g.eventDeleteHandle)):a.active[0]===!1&&j===!0&&(i.attr({opacity:.5}).toBack(),j=!1,c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(g.eventDeleteHandle));try{a.x!==undefined&&a.y!==undefined&&i.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(b){console.log(b)}},g.remove=function(){i.remove(),c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(g.eventDeleteHandle)},g.getExtents=function(){return{x:i.attr("cx"),y:i.attr("cy"),width:i.attr("rx")*2,height:i.attr("ry")*2}},g.eventClickHandle=function(a){a===f?d.updateItems([{id:f,active:!0}]):d.updateItems([{id:f,active:!1}])},g.eventResizeHandle=function(a,b){a===f&&d.updateItems([{id:f,w:b.width,h:b.height}])},g.eventMoveHandle=function(a,b){a===f&&d.updateItems([{id:f,x:b.x,y:b.y}])},g.eventDeleteHandle=function(a){a===f&&d.removeItems([f])},g.shapeIsActive=b.initEventFirer(!0,!1),g.shape=i,c.canvasEvents.registerRendering(g),e.events.onActiveAnnotationChange.addListener(g.eventClickHandle);return g}}},annoItem:{type:b.Presentation.AnnotationList,dataView:"drawspace",container:".anno_list",lenses:{Rectangle:function(b,c,d,e){var g={},h=d.getItem(e),i;a("#delete"+h.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([h.id[0]])}),i=f(h,b),g.annoEvents=c.annoActiveController.bind(i,{model:d,itemId:e}),g.clickEventHandle=function(a){a===e&&h.active[0]!==!0&&d.updateItems([{id:e,active:!0}])},g.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},g.annoEvents.events.eventClick.addListener(g.clickEventHandle),g.annoEvents.events.eventUpdate.addListener(g.updateEventHandle),g.update=function(a){a.active[0]?i.addClass("selected"):i.removeClass("selected")},g.remove=function(){a("#"+h.id).remove()};return g},Ellipse:function(b,c,d,e){var g={},h=d.getItem(e),i;a("#delete"+h.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([h.id[0]])}),i=f(h,b),g.annoEvents=annoActiveController.bind(i,{model:d,itemId:e}),g.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},g.annoEvents.events.eventUpdate.addListener(g.updateEventHandle),g.update=function(a){a.active[0]?i.addClass("selected"):i.removeClass("selected")},g.remove=function(){a("#"+h.id).remove()};return g}}}},cWidth:d.width,cHeight:d.height})),f=function(b,c){var d=b.active[0]?"anno_item selected":"anno_item",e='<div id="'+b.id[0]+'" class="'+d+'">'+'<div class="editArea">'+'<textarea class="bodyContentTextArea">'+b.bodyContent[0]+"</textarea>"+"<br/>"+'<div id="update'+b.id[0]+'" class="button update">Update</div>'+"</div>"+'<div class="bodyContent">'+"<p>"+b.bodyContent[0]+"</p>"+'<div id="#edit'+b.id[0]+'" class="button edit">Edit</div>'+"</div>"+"</div>";a("#"+b.id[0]).remove(),a(c).append(e),a("#"+b.id[0]+" > .editArea").hide();return a("#"+a(c).attr("id")+" > #"+b.id[0])},e.ready(function(){var b=[],c=e.dataStore.canvas.prepare(["!active"]);a("body").live("shapeActive",function(d,f){b=c.evaluate([!0]),a.each(b,function(a,b){e.dataStore.canvas.updateItems([{id:b,active:!1}])})}),e.dataStore.canvas.updateItems([{id:id,active:!0}])});return e}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo",{dataStores:{canvas:{types:{Rectangle:{},Ellipse:{}},properties:{bodyContent:{valueType:"String"},targetURI:{valueType:"Item"},active:{valueType:"Bool"}}}}}),function(a,b,c){c.Client.StreamingVideo.namespace("Controller"),c.Client.StreamingVideo.Controller.keyBoardListener=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.keyBoardListener",c);d.options=c,d.applyBindings=function(c,d){var e=c.locate("doc"),f,g=function(a){f=a};app.events.onActiveAnnotationChange.addListener(g),c.events={eventDelete:b.initEventFirer(!0,!0)},a(e).keydown(function(a){if(f!==undefined||f!=="")if(a.keyCode===8||a.keyCode===46)c.events.eventDelete.fire(f),f=""})};return d},c.Client.StreamingVideo.Controller.annotationEditSelectionGrid=function(c){that=b.Controller.initRaphaelController("OAC.Client.StreamingVideo.Controller.annotationEditSelectionGrid",c),c=that.options,that.handleSet,that.midDrag,that.svgBBox,that.rendering,that.handles={},that.itemMenu,that.deleteButton,that.editButton,that.menuContainer,that.dirs=that.options.dirs?opts.dirs:["ul","top","ur","lft","lr","btm","ll","rgt","mid"],that.eventResize=b.initEventFirer(!0,!1),that.eventDrag=b.initEventFirer(!0,!1),that.eventEdit=b.initEventFirer(!0,!1),that.eventDelete=b.initEventFirer(!0,!1),that.applyBindings=function(b,c){var d,e,f={},g,h,i=c.paper,j={},k=5;b.attachRendering=function(a){that.rendering=a,h=that.rendering.shape,calcFactors(),drawHandles(),that.rendering.eventResizeHandle!==undefined&&that.eventResize.addListener(that.rendering.eventResizeHandle),that.rendering.eventMoveHandle!==undefined&&that.eventDrag.addListener(that.rendering.eventMoveHandle)},b.detachRendering=function(){that.rendering.eventResizeHandle!==undefined&&that.eventResize.removeListener(that.rendering.eventResizeHandle),that.rendering.eventMoveHandle!==undefined&&that.eventDrag.removeListener(that.rendering.eventMoveHandle),that.handleSet.hide(),that.svgBBox.hide(),that.midDrag.hide(),that.itemMenu&&that.itemMenu.hide()},calcFactors=function(){var a,b;g=that.rendering.getExtents(),a=4*(d-g.x)/g.width+2,b=4*(e-g.y)/g.height+2,a<1?f.x=-1:a<3?f.x=0:f.x=1,b<1?f.y=-1:b<3?f.y=0:f.y=1,j.width=g.width+2*k,j.height=g.height+2*k,j.x=g.x-k/8-j.width/2,j.y=g.y-k/8-j.height/2,calcHandles(j),that.itemMenu&&drawMenu(j)},drawHandles=function(){if(that.handleSet===undefined){var b,c={},h;that.handleSet=i.set(),a.each(that.handles,function(a,c){a==="mid"?(that.midDrag=i.rect(c.x,c.y,k,k),c.id=that.midDrag.id):(b=i.rect(c.x,c.y,k,k),c.id=b.id,b.attr({cursor:c.cursor}),that.handleSet.push(b))}),that.handleSet.attr({fill:99e4,stroke:"black"}),that.midDrag!==undefined&&that.midDrag.attr({fill:99e4,stroke:"black",cursor:"move"}),that.svgBBox=i.rect(j.x,j.y,j.width,j.height),that.svgBBox.attr({stroke:"green","stroke-dasharray":["--"]}),drawMenu(j);if(that.midDrag!==undefined){var l,m,n,o;that.midDrag.drag(function(a,b){l=j.x+a,m=j.y+b,n=g.x+a,o=g.y+b,that.svgBBox.attr({x:l,y:m}),calcHandles({x:l,y:m,width:j.width,height:j.height}),that.itemMenu&&drawMenu({x:l,y:m,width:j.width,height:j.height})},function(a,b,c){d=c.offsetX,e=c.offsetY,calcFactors(),that.rendering.shape.attr({cursor:"move"})},function(){var a={x:n,y:o};that.eventDrag.fire(that.rendering.id,a),that.rendering.shape.attr({cursor:"default"})})}var p,b,q;that.handleSet.drag(function(a,c){var d,e,h,i;p=g.width+2*a*f.x,b=g.height+2*c*f.y,h=g.width+2*a*f.x+k*2,i=g.height+2*c*f.y+k*2,d=g.x-k/4-h/2,e=g.y-k/4-i/2,that.svgBBox.attr({x:d,y:e,width:h,height:i}),calcHandles({x:d,y:e,width:h,height:i}),that.itemMenu&&drawMenu({x:d,y:e,width:h,height:i})},function(a,b,c){d=c.offsetX,e=c.offsetY,calcFactors()},function(){q={width:p,height:b},that.eventResize.fire(that.rendering.id,q)})}else that.svgBBox.show(),that.svgBBox.attr({x:j.x,y:j.y,width:j.width,height:j.height}),that.handleSet.show(),that.midDrag.show().toFront(),that.itemMenu&&(that.itemMenu.show(),drawMenu(j))},drawMenu=function(a){if(that.itemMenu===undefined){var b,c,d,e,f,g,h;b=a.x+a.width,c=a.y-k*4-2,d=100,e=20,g={x:b+2,y:c+2,w:d/2-4,h:e-e/8},f={x:g.x+g.w+2,y:c+2,w:d/2-4,h:e-e/8},that.itemMenu=i.set(),that.menuContainer=i.rect(b,c,d,e),that.menuContainer.attr({fill:"#FFFFFF",stroke:"#000"}),that.itemMenu.push(that.menuContainer),that.editButton=i.rect(g.x,g.y,g.w,g.h),that.editButton.attr({fill:334009,cursor:"pointer"}),that.itemMenu.push(that.editButton),that.deleteButton=i.rect(f.x,f.y,f.w,f.h),that.deleteButton.attr({fill:334009,cursor:"pointer"}),that.itemMenu.push(that.deleteButton),that.editButton.mousedown(function(){that.rendering!==undefined&&that.eventEdit.fire(that.rendering.id)}),that.deleteButton.mousedown(function(){that.rendering!==undefined&&(that.eventDelete.fire(that.rendering.id),itemDeleted())})}else{var b,c,f,g;b=a.x+a.width,c=a.y-k*4-2,g={x:b+2,y:c+2},f={x:g.x+that.editButton.attr("width")+2,y:c+2},that.menuContainer.attr({x:b,y:c}),that.editButton.attr(g),that.deleteButton.attr(f)}},itemDeleted=function(){that.rendering=undefined,that.itemMenu.hide(),that.svgBBox.hide(),that.handleSet.hide(),that.midDrag.hide()},calcHandles=function(b){a.each(that.dirs,function(a,c){var d,e,f;switch(c){case"ul":that.handles.ul===undefined?that.handles.ul={x:b.x,y:b.y,cursor:"nw-resize"}:(e=b.x,f=b.y,that.handles.ul.x=e,that.handles.ul.y=f,d=i.getById(that.handles.ul.id),d.attr({x:e,y:f}));break;case"top":that.handles.top===undefined?that.handles.top={x:b.x+b.width/2,y:b.y,cursor:"n-resize"}:(e=b.x+b.width/2,f=b.y,that.handles.top.x=e,that.handles.top.y=f,d=i.getById(that.handles.top.id),d.attr({x:e,y:f}));break;case"ur":that.handles.ur===undefined?that.handles.ur={x:b.x+(b.width-k),y:b.y,cursor:"ne-resize"}:(e=b.x+(b.width-k),f=b.y,that.handles.ur.x=e,that.handles.ur.y=f,d=i.getById(that.handles.ur.id),d.attr({x:e,y:f}));break;case"rgt":that.handles.rgt===undefined?that.handles.rgt={x:b.x-k+b.width,y:b.y-k+b.height/2,cursor:"e-resize"}:(e=b.x-k+b.width,f=b.y-k+b.height/2,that.handles.rgt.x=e,that.handles.rgt.y=f,d=i.getById(that.handles.rgt.id),d.attr({x:e,y:f}));break;case"lr":that.handles.lr===undefined?that.handles.lr={x:b.x-k+b.width,y:b.y-k+b.width,cursor:"se-resize"}:(e=b.x-k+b.width,f=b.y-k+b.height,that.handles.lr.x=e,that.handles.lr.y=f,d=i.getById(that.handles.lr.id),d.attr({x:e,y:f}));break;case"btm":that.handles.btm===undefined?that.handles.btm={x:b.x+b.width/2,y:b.y-k+b.height,cursor:"s-resize"}:(e=b.x+b.width/2,f=b.y-k+b.height,that.handles.btm.x=e,that.handles.btm.y=f,d=i.getById(that.handles.btm.id),d.attr({x:e,y:f}));break;case"ll":that.handles.ll===undefined?that.handles.ll={x:b.x,y:b.y-k+b.height,cursor:"sw-resize"}:(e=b.x,f=b.y-k+b.height,that.handles.ll.x=e,that.handles.ll.y=f,d=i.getById(that.handles.ll.id),d.attr({x:e,y:f}));break;case"lft":that.handles.lft===undefined?that.handles.lft={x:b.x,y:b.y+b.height/2,cursor:"w-resize"}:(e=b.x,f=b.y+b.height/2,that.handles.lft.x=e,that.handles.lft.y=f,d=i.getById(that.handles.lft.id),d.attr({x:e,y:f}));break;case"mid":that.handles.mid===undefined?that.handles.mid={x:b.x+b.width/2,y:b.y+b.height/2,cursor:"pointer"}:(e=b.x+b.width/2,f=b.y+b.height/2,that.handles.mid.x=e,that.handles.mid.y=f,d=i.getById(that.handles.mid.id),d.attr({x:e,y:f}))}})}};return that},c.Client.StreamingVideo.Controller.annoActiveController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.annoActiveController",c);c=d.options,d.applyBindings=function(c,d){var e,f,g,h;e=c.locate("annotation"),f=c.locate("bodycontent"),g=c.locate("annotations"),textArea=c.locate("textarea"),editArea=c.locate("editarea"),editButton=c.locate("editbutton"),updateButton=c.locate("updatebutton"),h=c.locate("deletebutton"),c.events={},c.events.eventClick=b.initEventFirer(!0,!1),c.events.eventDelete=b.initEventFirer(!0,!1),c.events.eventUpdate=b.initEventFirer(!0,!1),c.renderings={},c.active=!1,c.registerRendering=function(a){renderings[a.id]=a,a.clickEventHandle!==undefined&&c.events.eventClick.addListener(a.clickEventHandle),a.deleteEventHandle===undefined},c.removeRendering=function(b){var d={};a.each(c.renderings,function(a,c){a!==b.id&&(d[a]=c)}),c.renderings=a.extend(!0,{},d)},editStart=function(){a(editArea).show(),a(f).hide(),c.active=!0,c.events.eventClick.fire(d.itemId)},editEnd=function(){a(editArea).hide(),a(f).show(),c.active=!1},editUpdate=function(b){b.preventDefault();var e=a(textArea).val();c.events.eventUpdate.fire(d.itemId,e),editEnd()},a(editButton).live("click",function(a){a.preventDefault(),c.active?editEnd():editStart()}),a(updateButton).live("click",editUpdate),a(e).live("click",function(a){c.events.eventClick.fire(d.itemId)})};return d},c.Client.StreamingVideo.Controller.canvasController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.canvasClickController",c);d.options=c,d.applyBindings=function(c,d){var e,f,g,h,i=c.locate("svg"),j=d.closeEnough,k,l,m,n,o,p,q=d.paper,r=a(i).offset();c.event={},c.event.eventClick=b.initEventFirer(!0,!1),c.renderings={},c.curRendering,c.registerRendering=function(a){c.renderings[a.id]=a,a.eventClickHandle!==undefined&&c.event.eventClick.addListener(a.eventClickHandle),a.shapeIsActive!==undefined&&a.shapeIsActive.addListener(attachDragResize)},c.removeRendering=function(b){var d={},e;b.eventClickHandle!==undefined&&c.event.eventClick.removeListener(b.eventClickHandle),a.each(c.renderings,function(a,c){a!==b.id&&(d[a]=c)}),c.renderings=a.extend(!0,{},d)},attachDragResize=function(a){if(c.curRendering===undefined||a!==c.curRendering.id){var b=c.renderings[a];if(b===undefined){c.event.eventClick.fire(""),c.curRendering=undefined;return!1}c.curRendering=b}},detachDragResize=function(a){if(c.curRendering===undefined||a!==c.curRendering.id)var b=c.renderings[a]},a(i).bind("mousedown",function(b){h="",e=Math.abs(b.pageX-r.left),f=Math.abs(b.pageY-r.top),a.each(c.renderings,function(a,b){g=b.getExtents(),k=Math.abs(e-g.x),l=Math.abs(f-g.y);if(k<=g.width&&l<=g.height){h=b.id;if(c.curRendering===undefined||b.id!==c.curRendering.id)c.curRendering=b,app.setActiveAnnotation(b.id);return!1}}),h.length==0&&c.curRendering!==undefined&&(app.setActiveAnnotation(""),c.curRendering=undefined)})};return d}}(jQuery,MITHGrid,OAC),function(a,b,c){var d,e,f,g;d=c.Client.StreamingVideo.Controller.canvasController({selectors:{svg:""}}),e=c.Client.StreamingVideo.Controller.annotationEditSelectionGrid({}),f=c.Client.StreamingVideo.Controller.keyBoardListener({selectors:{doc:""}}),g=c.Client.StreamingVideo.Controller.annoActiveController({selectors:{annotation:"",annotationlist:":parent",bodycontent:"> .bodyContent",editbutton:"> .bodyContent > .button.edit",editarea:"> .editArea",textarea:"> .editArea > textarea",updatebutton:"> .editArea > .button.update",deletebutton:"> .button.delete"}}),b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(c,d){var e=b.Presentation.initPresentation("AnnotationList",c,d);e.annoListController=g.bind(a(c),{});return e},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(c,g){var h=b.Presentation.initPresentation("RaphaelCanvas",c,g),i=a(c).attr("id"),j,k;g.cWidth!==undefined?k=g.cWidth:k=a(c).width(),g.cHeight!==undefined?j=g.cHeight:j=a(c).height(),h.canvas=new Raphael(i,k,j),h.canvasEvents=d.bind(c,{closeEnough:5,paper:h.canvas}),h.editBoundingBox=e.bind(a(c),{paper:h.canvas}),h.keyBoardListener=f.bind(a("body"),{});return h}}(jQuery,MITHGrid,OAC);