/*
 *  OAC Video Annotation Tool v0.1
 * 
 *  Developed as a plugin for the MITHGrid framework. 
 *  
 *  Date: Mon Nov 28 13:10:21 2011 -0500
 *  
 * Educational Community License, Version 2.0
 * 
 * Copyright 2011 University of Maryland. Licensed under the Educational
 * Community License, Version 2.0 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * 
 * http://www.osedu.org/licenses/ECL-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 */
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=OAC||{},app={};MITHGrid.globalNamespace("OAC"),OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){c.Client.StreamingVideo.initApp=function(d,e){var f,g,h,i,j;i=function(a,b,c,d){var e={id:d};e.makeActive=function(){e.shape.attr({opacity:1}).toFront(),b.editBoundingBox.attachRendering(e),b.keyBoardListener.events.onDelete.addListener(e.eventDeleteHandle)},e.makeInactive=function(){e.shape.attr({opacity:.5}).toBack(),b.editBoundingBox.detachRendering(),b.keyBoardListener.events.onDelete.removeListener(e.eventDeleteHandle)},e.remove=function(a){e.shape.remove(),b.editBoundingBox.detachRendering(),b.keyBoardListener.events.onDelete.removeListener(e.eventDeleteHandle)},e.eventDeleteHandle=function(a){a===d&&c.removeItems([d])},e.eventResizeHandle=function(a,b){a===d&&c.updateItems([{id:d,w:b.width,h:b.height}])},e.eventMoveHandle=function(a,b){a===d&&c.updateItems([{id:d,x:b.x,y:b.y}])};return e},j=function(b,c,d,e){var i={},j=d.getItem(e),k;a("#delete"+j.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([j.id[0]])}),k=f(j,b),i.annoEvents=g.bind(k,{model:d,itemId:e}),i.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},i.clickEventHandle=h.setActiveAnnotation,i.annoEvents.events.onClick.addListener(i.clickEventHandle),i.annoEvents.events.onUpdate.addListener(i.updateEventHandle),i.makeActive=function(){k.addClass("selected")},i.makeInactive=function(){k.removeClass("selected")},i.update=function(b){a(k).find(".bodyContent").text(b.bodyContent[0])},i.remove=function(){a(k).remove()},h.getActiveAnnotation()===e&&i.makeActive();return i},h=b.Application.initApp("OAC.Client.StreamingVideo",d,a.extend(!0,{},e,{variables:{ActiveAnnotation:{is:"rw"}},dataViews:{drawspace:{dataStore:"canvas",types:["Rectangle","Ellipse"],label:"drawspace"}},viewSetup:'<div class="canvas_svg_holder"><div id="canvasSVG" class="canvas_svg"></div></div><div id="annoList" class="anno_list"></div>',presentations:{raphsvg:{type:b.Presentation.RaphaelCanvas,container:"#canvasSVG",dataView:"drawspace",lenses:{Rectangle:function(a,c,d,e){var f=i(a,c,d,e),g=d.getItem(e),j,k,l,m,n=e===h.getActiveAnnotation();k=g.x-g.w[0]/2,l=g.y-g.h[0]/2,j=c.canvas.rect(k,l,g.w[0],g.h[0]),j.attr({fill:"red",opacity:n?1:.5}),f.update=function(a){try{a.x!==undefined&&a.y!==undefined&&a.w!==undefined&&a.y!==undefined&&f.shape.attr({x:a.x[0]-a.w[0]/2,y:a.y[0]-a.h[0]/2,width:a.w[0],height:a.h[0]})}catch(c){b.debug(c)}},f.getExtents=function(){return{x:j.attr("x")+j.attr("width")/2,y:j.attr("y")+j.attr("height")/2,width:j.attr("width"),height:j.attr("height")}},f.shape=j,c.canvasEvents.registerRendering(f);return f},Ellipse:function(a,c,d,e){var f=i(a,c,d,e),g=d.getItem(e),j,k=e===h.getActiveAnnotation();j=c.canvas.ellipse(g.x[0],g.y[0],g.w[0]/2,g.h[0]/2),j.attr({fill:"red",opacity:k?1:.5}),f.update=function(a){try{a.x!==undefined&&a.y!==undefined&&j.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(c){b.debug(c)}},f.getExtents=function(){return{x:j.attr("cx"),y:j.attr("cy"),width:j.attr("rx")*2,height:j.attr("ry")*2}},f.shape=j,c.canvasEvents.registerRendering(f);return f}}},annoItem:{type:b.Presentation.AnnotationList,dataView:"drawspace",container:".anno_list",lenses:{Rectangle:j,Ellipse:j}}},cWidth:e.width,cHeight:e.height})),f=function(b,c){var d=a('<div class="anno_item"><div class="editArea"><textarea class="bodyContentTextArea"></textarea></div><div class="body"><p class="bodyContent"></p></div></div>'),e=a(d).find(".bodyContentTextArea"),f=a(d).find(".bodyContent");a(e).text(b.bodyContent[0]),a(f).text(b.bodyContent[0]),a(c).append(d),a(d).find(".editArea").hide();return a(d)},h.ready(function(){g=c.Client.StreamingVideo.Controller.annoActiveController({application:h,selectors:{annotation:"",annotationlist:":parent",bodycontent:".bodyContent",body:".body",editbutton:".button.edit",editarea:".editArea",textarea:".editArea > textarea",updatebutton:".button.update",deletebutton:".button.delete"}}),h.events.onActiveAnnotationChange.addListener(h.presentation.raphsvg.eventActiveRenderingChange),h.events.onActiveAnnotationChange.addListener(h.presentation.annoItem.eventActiveRenderingChange)});return h}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo",{dataStores:{canvas:{types:{Rectangle:{},Ellipse:{}},properties:{bodyContent:{valueType:"String"},targetURI:{valueType:"Item"},active:{valueType:"Bool"}}}}}),function(a,b,c){c.Client.StreamingVideo.namespace("Controller"),b.defaults("OAC.Client.StreamingVideo.Controller.keyBoardListener",{bind:{events:{onDelete:["preventable","unicast"]}}}),c.Client.StreamingVideo.Controller.keyBoardListener=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.keyBoardListener",c);c=d.options,d.applyBindings=function(b,d){var e=b.locate("doc"),f,g=function(a){f=a};c.application.events.onActiveAnnotationChange.addListener(g),a(e).keydown(function(a){if(f!==undefined||f!=="")if(a.keyCode===8||a.keyCode===46)b.events.onDelete.fire(f),f=""})};return d},b.defaults("OAC.Client.StreamingVideo.Controller.annotationEditSelectionGrid",{events:{onResize:"preventable",onDrag:"preventable",onEdit:"preventable",onDelete:"preventable"}}),c.Client.StreamingVideo.Controller.annotationEditSelectionGrid=function(c){var d=b.Controller.initRaphaelController("OAC.Client.StreamingVideo.Controller.annotationEditSelectionGrid",c),e={},f={},g=[],h={},i={};c=d.options,d.handles={},d.rendering={},d.deleteButton={},d.editButton={},d.menuContainer={},g=d.options.dirs||["ul","top","ur","lft","lr","btm","ll","rgt","mid"],d.applyBindings=function(b,c){var j,k,l={},m,n,o=c.paper,p={},q=5,r,s,t,u,v={},w,x={},y={},z={},A,B={},C={},D;b.attachRendering=function(a){d.rendering=a,n=d.rendering.shape,r(),w(),d.rendering.eventResizeHandle!==undefined&&d.events.onResize.addListener(d.rendering.eventResizeHandle),d.rendering.eventMoveHandle!==undefined&&d.events.onDrag.addListener(d.rendering.eventMoveHandle)},b.detachRendering=function(){d.rendering.eventResizeHandle!==undefined&&d.events.onResize.removeListener(d.rendering.eventResizeHandle),d.rendering.eventMoveHandle!==undefined&&d.events.onDrag.removeListener(d.rendering.eventMoveHandle),e.hide(),h.hide(),f.hide(),i&&i.hide()},r=function(){var a,b;m=d.rendering.getExtents(),a=4*(j-m.x)/m.width+2,b=4*(k-m.y)/m.height+2,a<1?l.x=-1:a<3?l.x=0:l.x=1,b<1?l.y=-1:b<3?l.y=0:l.y=1,p.width=m.width+2*q,p.height=m.height+2*q,p.x=m.x-q/8-p.width/2,p.y=m.y-q/8-p.height/2,s(p),i&&t(p)},w=function(){a.isEmptyObject(e)?(e=o.set(),a.each(d.handles,function(a,b){var c;a==="mid"?(f=o.rect(b.x,b.y,q,q),b.id=f.id):(c=o.rect(b.x,b.y,q,q),b.id=c.id,c.attr({cursor:b.cursor}),e.push(c))}),e.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(f)||f.attr({fill:99e4,stroke:"black",cursor:"move"}),h=o.rect(p.x,p.y,p.width,p.height),h.attr({stroke:"green","stroke-dasharray":["--"]}),t(p),a.isEmptyObject(f)||f.drag(function(a,b){x.nx=p.x+a,x.ny=p.y+b,y.x=m.x+a,y.y=m.y+b,h.attr({x:x.nx,y:x.ny}),s({x:x.nx,y:x.ny,width:p.width,height:p.height}),i&&t({x:x.nx,y:x.ny,width:p.width,height:p.height})},function(a,b,c){j=c.offsetX,k=c.offsetY,r(),d.rendering.shape.attr({cursor:"move"})},function(){var a={x:y.x,y:y.y};d.events.onDrag.fire(d.rendering.id,a),d.rendering.shape.attr({cursor:"default"})}),e.drag(function(a,b){y.w=m.width+2*a*l.x,y.h=m.height+2*b*l.y,x.nw=m.width+2*a*l.x+q*2,x.nh=m.height+2*b*l.y+q*2,x.nx=m.x-q/4-x.nw/2,x.ny=m.y-q/4-x.nh/2,h.attr({x:x.nx,y:x.ny,width:x.nw,height:x.nh}),s({x:x.nx,y:x.ny,width:x.nw,height:x.nh}),i&&t({x:x.nx,y:x.ny,width:x.nw,height:x.nh})},function(a,b,c){j=c.offsetX,k=c.offsetY,r()},function(){var a={width:y.w,height:y.h};d.events.onResize.fire(d.rendering.id,a)})):(h.show(),h.attr({x:p.x,y:p.y,width:p.width,height:p.height}),e.show(),f.show().toFront(),i&&(i.show(),t(p)))},t=function(b){a.isEmptyObject(i)?(z.x=b.x+b.width,z.y=b.y-q*4-2,z.w=100,z.h=20,C={x:z.x+2,y:z.y+2,w:z.w/2-4,h:z.h-z.h/8},B={x:C.x+C.w+2,y:z.y+2,w:z.w/2-4,h:z.h-z.h/8},i=o.set(),d.menuContainer=o.rect(z.x,z.y,z.w,z.h),d.menuContainer.attr({fill:"#FFFFFF",stroke:"#000"}),i.push(d.menuContainer),d.editButton=o.rect(C.x,C.y,C.w,C.h),d.editButton.attr({fill:334009,cursor:"pointer"}),i.push(d.editButton),d.deleteButton=o.rect(B.x,B.y,B.w,B.h),d.deleteButton.attr({fill:334009,cursor:"pointer"}),i.push(d.deleteButton),d.editButton.mousedown(function(){d.rendering!==undefined&&d.events.onEdit.fire(d.rendering.id)}),d.deleteButton.mousedown(function(){d.rendering!==undefined&&(d.events.onDelete.fire(d.rendering.id),u())})):(z.x=b.x+b.width,z.y=b.y-q*4-2,C={x:z.x+2,y:z.y+2},B={x:C.x+d.editButton.attr("width")+2,y:z.y+2},d.menuContainer.attr({x:z.x,y:z.y}),d.editButton.attr(C),d.deleteButton.attr(B))},u=function(){d.rendering=undefined,i.hide(),h.hide(),e.hide(),f.hide()},s=function(b){a.each(g,function(a,c){switch(c){case"ul":d.handles.ul===undefined?d.handles.ul={x:b.x,y:b.y,cursor:"nw-resize"}:(d.handles.ul.x=b.x,d.handles.ul.y=b.y,D=o.getById(d.handles.ul.id),D.attr({x:d.handles.ul.x,y:d.handles.ul.y}));break;case"top":d.handles.top===undefined?d.handles.top={x:b.x+b.width/2,y:b.y,cursor:"n-resize"}:(d.handles.top.x=b.x+b.width/2,d.handles.top.y=b.y,D=o.getById(d.handles.top.id),D.attr({x:d.handles.top.x,y:d.handles.top.y}));break;case"ur":d.handles.ur===undefined?d.handles.ur={x:b.x+(b.width-q),y:b.y,cursor:"ne-resize"}:(d.handles.ur.x=b.x+(b.width-q),d.handles.ur.y=b.y,D=o.getById(d.handles.ur.id),D.attr({x:d.handles.ur.x,y:d.handles.ur.y}));break;case"rgt":d.handles.rgt===undefined?d.handles.rgt={x:b.x-q+b.width,y:b.y-q+b.height/2,cursor:"e-resize"}:(d.handles.rgt.x=b.x-q+b.width,d.handles.rgt.y=b.y-q+b.height/2,D=o.getById(d.handles.rgt.id),D.attr({x:d.handles.rgt.x,y:d.handles.rgt.y}));break;case"lr":d.handles.lr===undefined?d.handles.lr={x:b.x-q+b.width,y:b.y-q+b.width,cursor:"se-resize"}:(d.handles.lr.x=b.x-q+b.width,d.handles.lr.y=b.y-q+b.height,D=o.getById(d.handles.lr.id),D.attr({x:d.handles.lr.x,y:d.handles.lr.y}));break;case"btm":d.handles.btm===undefined?d.handles.btm={x:b.x+b.width/2,y:b.y-q+b.height,cursor:"s-resize"}:(d.handles.btm.x=b.x+b.width/2,d.handles.btm.y=b.y-q+b.height,D=o.getById(d.handles.btm.id),D.attr({x:d.handles.btm.x,y:d.handles.btm.y}));break;case"ll":d.handles.ll===undefined?d.handles.ll={x:b.x,y:b.y-q+b.height,cursor:"sw-resize"}:(d.handles.ll.x=b.x,d.handles.ll.y=b.y-q+b.height,D=o.getById(d.handles.ll.id),D.attr({x:d.handles.ll.x,y:d.handles.ll.y}));break;case"lft":d.handles.lft===undefined?d.handles.lft={x:b.x,y:b.y+b.height/2,cursor:"w-resize"}:(d.handles.lft.x=b.x,d.handles.lft.y=b.y+b.height/2,D=o.getById(d.handles.lft.id),D.attr({x:d.handles.lft.x,y:d.handles.lft.y}));break;case"mid":d.handles.mid===undefined?d.handles.mid={x:b.x+b.width/2,y:b.y+b.height/2,cursor:"pointer"}:(d.handles.mid.x=b.x+b.width/2,d.handles.mid.y=b.y+b.height/2,D=o.getById(d.handles.mid.id),D.attr({x:d.handles.mid.x,y:d.handles.mid.y}))}})}};return d},b.defaults("OAC.Client.StreamingVideo.Controller.annoActiveController",{bind:{events:{onClick:"preventable",onDelete:"preventable",onUpdate:"preventable"}}}),c.Client.StreamingVideo.Controller.annoActiveController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.annoActiveController",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i,j,k,l,m,n,o;e=b.locate("annotation"),f=b.locate("body"),g=b.locate("annotations"),j=b.locate("textarea"),i=b.locate("editarea"),k=b.locate("editbutton"),l=b.locate("updatebutton"),h=b.locate("deletebutton"),b.renderings={},b.active=!1,m=function(){a(i).show(),a(f).hide(),b.active=!0,b.events.onClick.fire(d.itemId)},n=function(){a(i).hide(),a(f).show(),b.active=!1},o=function(c){c.preventDefault();var e=a(j).val();b.events.onUpdate.fire(d.itemId,e),n()},a(f).bind("dblclick",function(a){a.preventDefault(),b.active?n():m()}),a(e).bind("click",function(a){c.application.setActiveAnnotation(d.itemId)}),c.application.events.onActiveAnnotationChange.addListener(function(a){a!==d.id&&b.active&&(o({preventDefault:function(){}}),n())})};return d},b.defaults("OAC.Client.StreamingVideo.Controller.canvasClickController",{bind:{events:{onClick:"preventable"}}}),c.Client.StreamingVideo.Controller.canvasController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.canvasClickController",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i=b.locate("svg"),j=d.closeEnough,k,l,m,n,o,p,q=d.paper,r=a(i).offset(),s=function(a){if(b.curRendering===undefined||a!==b.curRendering.id){var c=b.renderings[a];if(c===undefined){b.events.onClick.fire(undefined),b.curRendering=undefined;return!1}b.curRendering=c}},t=function(a){if(b.curRendering===undefined||a!==b.curRendering.id)var c=b.renderings[a]};c.application.events.onActiveAnnotationChange.addListener(s),b.renderings={},b.curRendering=undefined,b.registerRendering=function(a){b.renderings[a.id]=a},b.removeRendering=function(c){var d={},e;a.each(b.renderings,function(a,b){a!==c.id&&(d[a]=b)}),b.renderings=a.extend(!0,{},d)},a(i).bind("mousedown",function(d){h="",r=a(i).offset(),e=Math.abs(d.pageX-r.left),f=Math.abs(d.pageY-r.top);if(b.curRendering!==undefined){g=b.curRendering.getExtents(),k=Math.abs(e-g.x),l=Math.abs(f-g.y);if(k<=g.width/2+3&&l<=g.height/2+3)return}a.each(b.renderings,function(a,d){g=d.getExtents(),k=Math.abs(e-g.x),l=Math.abs(f-g.y);if(k<=g.width/2+3&&l<=g.height/2+3){h=d.id;if(b.curRendering===undefined||d.id!==b.curRendering.id)b.curRendering=d,c.application.setActiveAnnotation(d.id);return!1}}),h.length===0&&b.curRendering!==undefined&&(c.application.setActiveAnnotation(undefined),b.curRendering=undefined)})};return d}}(jQuery,MITHGrid,OAC),function(a,b,c){b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(a,c){var d=b.Presentation.initPresentation("AnnotationList",a,c),e;d.eventActiveRenderingChange=function(a){var b;typeof e!="undefined"&&e!==null&&(b=d.renderingFor(e)),e!==a&&(b&&typeof b.makeInactive!="undefined"&&b.makeInactive(),typeof a!="undefined"&&a!==null&&(b=d.renderingFor(a),b&&typeof b.makeActive!="undefined"&&b.makeActive()),e=a)};return d},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(d,e){var f=b.Presentation.initPresentation("RaphaelCanvas",d,e),g=a(d).attr("id"),h,i,j,k,l,m;k=c.Client.StreamingVideo.Controller.canvasController({application:f.options.application,selectors:{svg:""}}),l=c.Client.StreamingVideo.Controller.keyBoardListener({application:f.options.application,selectors:{doc:""}}),m=c.Client.StreamingVideo.Controller.annotationEditSelectionGrid({application:f.options.application}),e.cWidth!==undefined?i=e.cWidth:i=a(d).width(),e.cHeight!==undefined?h=e.cHeight:h=a(d).height(),f.canvas=new Raphael(g,i,h),f.canvasEvents=k.bind(d,{closeEnough:5,paper:f.canvas}),f.editBoundingBox=m.bind(a(d),{paper:f.canvas}),f.keyBoardListener=l.bind(a("body"),{}),f.eventActiveRenderingChange=function(a){var b;typeof j!="undefined"&&j!==null&&(b=f.renderingFor(j)),j!==a&&(b&&typeof b.makeInactive!="undefined"&&b.makeInactive(),typeof a!="undefined"&&a!==null&&(b=f.renderingFor(a),b&&typeof b.makeActive!="undefined"&&b.makeActive()),j=a)};return f}}(jQuery,MITHGrid,OAC);