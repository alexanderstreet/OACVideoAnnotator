/*
 *  OAC Video Annotation Tool v0.1
 * 
 *  Developed as a plugin for the MITHGrid framework. 
 *  
 *  Date: Mon Nov 14 17:00:37 2011 -0500
 *  
 * Educational Community License, Version 2.0
 * 
 * Copyright 2011 University of Maryland. Licensed under the Educational
 * Community License, Version 2.0 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * 
 * http://www.osedu.org/licenses/ECL-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 */
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=OAC||{},app={};MITHGrid.globalNamespace("OAC"),OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){c.Client.StreamingVideo.initApp=function(d,e){var f,g;g=c.Client.StreamingVideo.Controller.annoActiveController({selectors:{annotation:"",annotationlist:":parent",bodycontent:"> .bodyContent",editbutton:"> .bodyContent > .button.edit",editarea:"> .editArea",textarea:"> .editArea > textarea",updatebutton:"> .editArea > .button.update",deletebutton:"> .button.delete"}}),app=b.Application.initApp("OAC.Client.StreamingVideo",d,a.extend(!0,{},e,{variables:{ActiveAnnotation:{is:"rw"}},dataViews:{drawspace:{dataStore:"canvas",types:["Rectangle","Ellipse"],label:"drawspace"}},viewSetup:'<div id="canvasSVG" class="canvas_svg"></div><div id="annoList" class="anno_list"></div>',presentations:{raphsvg:{type:b.Presentation.RaphaelCanvas,container:"#canvasSVG",dataView:"drawspace",lenses:{Rectangle:function(a,c,d,e){var f={id:e},g=d.getItem(e),h,i,j,k,l=g.active[0];i=g.x-g.w[0]/2,j=g.y-g.h[0]/2,h=c.canvas.rect(i,j,g.w[0],g.h[0]),h.attr({fill:"red",opacity:l?1:.5}),f.update=function(a){a.active[0]&&l===!1?(h.attr({opacity:1}).toFront(),l=!0,c.editBoundingBox.attachRendering(f),c.keyBoardListener.events.eventDelete.addListener(f.eventDeleteHandle)):a.active[0]===!1&&l===!0&&(h.attr({opacity:.5}).toBack(),l=!1,c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle));try{a.x!==undefined&&a.y!==undefined&&a.w!==undefined&&a.y!==undefined&&f.shape.attr({x:a.x[0]-a.w[0]/2,y:a.y[0]-a.h[0]/2,width:a.w[0],height:a.h[0]})}catch(b){console.log(b)}},f.remove=function(a){h.remove(),c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle)},f.getExtents=function(){return{x:h.attr("x")+h.attr("width")/2,y:h.attr("y")+h.attr("height")/2,width:h.attr("width"),height:h.attr("height")}},f.shapeIsActive=b.initEventFirer(!1,!1),f.eventClickHandle=function(a){console.log("event click handle in rectangular "+a),a===e?d.updateItems([{id:e,active:!0}]):d.updateItems([{id:e,active:!1}])},f.eventResizeHandle=function(a,b){a===e&&d.updateItems([{id:e,w:b.width,h:b.height}])},f.eventMoveHandle=function(a,b){a===e&&d.updateItems([{id:e,x:b.x,y:b.y}])},f.eventDeleteHandle=function(a){a===e&&d.removeItems([e])},f.shape=h,c.canvasEvents.registerRendering(f),app.events.onActiveAnnotationChange.addListener(f.eventClickHandle);return f},Ellipse:function(a,c,d,e){var f={id:e},g=d.getItem(e),h,i=g.active[0];h=c.canvas.ellipse(g.x[0],g.y[0],g.w[0]/2,g.h[0]/2),h.attr({fill:"red",opacity:i?1:.5}),f.update=function(a){a.active[0]&&i===!1?(h.attr({opacity:1}).toFront(),i=!0,c.editBoundingBox.attachRendering(f),c.keyBoardListener.events.eventDelete.addListener(f.eventDeleteHandle)):a.active[0]===!1&&i===!0&&(h.attr({opacity:.5}).toBack(),i=!1,c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle));try{a.x!==undefined&&a.y!==undefined&&h.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(b){console.log(b)}},f.remove=function(){h.remove(),c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle)},f.getExtents=function(){return{x:h.attr("cx"),y:h.attr("cy"),width:h.attr("rx")*2,height:h.attr("ry")*2}},f.eventClickHandle=function(a){a===e?d.updateItems([{id:e,active:!0}]):d.updateItems([{id:e,active:!1}])},f.eventResizeHandle=function(a,b){a===e&&d.updateItems([{id:e,w:b.width,h:b.height}])},f.eventMoveHandle=function(a,b){a===e&&d.updateItems([{id:e,x:b.x,y:b.y}])},f.eventDeleteHandle=function(a){a===e&&d.removeItems([e])},f.shapeIsActive=b.initEventFirer(!0,!1),f.shape=h,c.canvasEvents.registerRendering(f),app.events.onActiveAnnotationChange.addListener(f.eventClickHandle);return f}}},annoItem:{type:b.Presentation.AnnotationList,dataView:"drawspace",container:".anno_list",lenses:{Rectangle:function(b,c,d,e){var h={},i=d.getItem(e),j;a("#delete"+i.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([i.id[0]])}),j=f(i,b),h.annoEvents=g.bind(j,{model:d,itemId:e}),h.clickEventHandle=function(a){a===e&&i.active[0]!==!0&&d.updateItems([{id:e,active:!0}])},h.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},h.annoEvents.events.eventClick.addListener(h.clickEventHandle),h.annoEvents.events.eventUpdate.addListener(h.updateEventHandle),h.update=function(a){a.active[0]?j.addClass("selected"):j.removeClass("selected")},h.remove=function(){a("#"+i.id).remove()};return h},Ellipse:function(b,c,d,e){var h={},i=d.getItem(e),j;a("#delete"+i.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([i.id[0]])}),j=f(i,b),h.annoEvents=g.bind(j,{model:d,itemId:e}),h.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},h.annoEvents.events.eventUpdate.addListener(h.updateEventHandle),h.update=function(a){a.active[0]?j.addClass("selected"):j.removeClass("selected")},h.remove=function(){a("#"+i.id).remove()};return h}}}},cWidth:e.width,cHeight:e.height})),f=function(b,c){var d=b.active[0]?"anno_item selected":"anno_item",e='<div id="'+b.id[0]+'" class="'+d+'">'+'<div class="editArea">'+'<textarea class="bodyContentTextArea">'+b.bodyContent[0]+"</textarea>"+"<br/>"+'<div id="update'+b.id[0]+'" class="button update">Update</div>'+"</div>"+'<div class="bodyContent">'+"<p>"+b.bodyContent[0]+"</p>"+'<div id="#edit'+b.id[0]+'" class="button edit">Edit</div>'+"</div>"+"</div>";a("#"+b.id[0]).remove(),a(c).append(e),a("#"+b.id[0]+" > .editArea").hide();return a("#"+a(c).attr("id")+" > #"+b.id[0])};return app}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo",{dataStores:{canvas:{types:{Rectangle:{},Ellipse:{}},properties:{bodyContent:{valueType:"String"},targetURI:{valueType:"Item"},active:{valueType:"Bool"}}}}}),function(a,b,c){c.Client.StreamingVideo.namespace("Controller"),c.Client.StreamingVideo.Controller.keyBoardListener=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.keyBoardListener",c);d.options=c,d.applyBindings=function(c,d){var e=c.locate("doc"),f,g=function(a){f=a};app.events.onActiveAnnotationChange.addListener(g),c.events={eventDelete:b.initEventFirer(!0,!0)},a(e).keydown(function(a){if(f!==undefined||f!=="")if(a.keyCode===8||a.keyCode===46)c.events.eventDelete.fire(f),f=""})};return d},c.Client.StreamingVideo.Controller.annotationEditSelectionGrid=function(c){var d=b.Controller.initRaphaelController("OAC.Client.StreamingVideo.Controller.annotationEditSelectionGrid",c);c=d.options,d.handleSet={},d.midDrag={},d.svgBBox={},d.rendering={},d.handles={},d.itemMenu={},d.deleteButton={},d.editButton={},d.menuContainer={},d.dirs=d.options.dirs||["ul","top","ur","lft","lr","btm","ll","rgt","mid"],d.eventResize=b.initEventFirer(!0,!1),d.eventDrag=b.initEventFirer(!0,!1),d.eventEdit=b.initEventFirer(!0,!1),d.eventDelete=b.initEventFirer(!0,!1),d.applyBindings=function(b,c){var e,f,g={},h,i,j=c.paper,k={},l=5,m,n,o,p;b.attachRendering=function(a){d.rendering=a,i=d.rendering.shape,m(),p(),d.rendering.eventResizeHandle!==undefined&&d.eventResize.addListener(d.rendering.eventResizeHandle),d.rendering.eventMoveHandle!==undefined&&d.eventDrag.addListener(d.rendering.eventMoveHandle)},b.detachRendering=function(){d.rendering.eventResizeHandle!==undefined&&d.eventResize.removeListener(d.rendering.eventResizeHandle),d.rendering.eventMoveHandle!==undefined&&d.eventDrag.removeListener(d.rendering.eventMoveHandle),d.handleSet.hide(),d.svgBBox.hide(),d.midDrag.hide(),d.itemMenu&&d.itemMenu.hide()},m=function(){var a,b;h=d.rendering.getExtents(),a=4*(e-h.x)/h.width+2,b=4*(f-h.y)/h.height+2,a<1?g.x=-1:a<3?g.x=0:g.x=1,b<1?g.y=-1:b<3?g.y=0:g.y=1,k.width=h.width+2*l,k.height=h.height+2*l,k.x=h.x-l/8-k.width/2,k.y=h.y-l/8-k.height/2,n(k),d.itemMenu&&o(k)},p=function(){if(a.isEmptyObject(d.handleSet)){var b,c={},i;d.handleSet=j.set(),a.each(d.handles,function(a,c){a==="mid"?(d.midDrag=j.rect(c.x,c.y,l,l),c.id=d.midDrag.id):(b=j.rect(c.x,c.y,l,l),c.id=b.id,b.attr({cursor:c.cursor}),d.handleSet.push(b))}),d.handleSet.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(d.midDrag)||d.midDrag.attr({fill:99e4,stroke:"black",cursor:"move"}),d.svgBBox=j.rect(k.x,k.y,k.width,k.height),d.svgBBox.attr({stroke:"green","stroke-dasharray":["--"]}),o(k);if(!a.isEmptyObject(d.midDrag)){var p,q,r,s;d.midDrag.drag(function(a,b){p=k.x+a,q=k.y+b,r=h.x+a,s=h.y+b,d.svgBBox.attr({x:p,y:q}),n({x:p,y:q,width:k.width,height:k.height}),d.itemMenu&&o({x:p,y:q,width:k.width,height:k.height})},function(a,b,c){e=c.offsetX,f=c.offsetY,m(),d.rendering.shape.attr({cursor:"move"})},function(){var a={x:r,y:s};d.eventDrag.fire(d.rendering.id,a),d.rendering.shape.attr({cursor:"default"})})}var t,b,u;d.handleSet.drag(function(a,c){var e,f,i,j;t=h.width+2*a*g.x,b=h.height+2*c*g.y,i=h.width+2*a*g.x+l*2,j=h.height+2*c*g.y+l*2,e=h.x-l/4-i/2,f=h.y-l/4-j/2,d.svgBBox.attr({x:e,y:f,width:i,height:j}),n({x:e,y:f,width:i,height:j}),d.itemMenu&&o({x:e,y:f,width:i,height:j})},function(a,b,c){e=c.offsetX,f=c.offsetY,m()},function(){u={width:t,height:b},d.eventResize.fire(d.rendering.id,u)})}else d.svgBBox.show(),d.svgBBox.attr({x:k.x,y:k.y,width:k.width,height:k.height}),d.handleSet.show(),d.midDrag.show().toFront(),d.itemMenu&&(d.itemMenu.show(),o(k))},o=function(b){if(a.isEmptyObject(d.itemMenu)){var c,e,f,g,h,i,k;c=b.x+b.width,e=b.y-l*4-2,f=100,g=20,i={x:c+2,y:e+2,w:f/2-4,h:g-g/8},h={x:i.x+i.w+2,y:e+2,w:f/2-4,h:g-g/8},d.itemMenu=j.set(),d.menuContainer=j.rect(c,e,f,g),d.menuContainer.attr({fill:"#FFFFFF",stroke:"#000"}),d.itemMenu.push(d.menuContainer),d.editButton=j.rect(i.x,i.y,i.w,i.h),d.editButton.attr({fill:334009,cursor:"pointer"}),d.itemMenu.push(d.editButton),d.deleteButton=j.rect(h.x,h.y,h.w,h.h),d.deleteButton.attr({fill:334009,cursor:"pointer"}),d.itemMenu.push(d.deleteButton),d.editButton.mousedown(function(){d.rendering!==undefined&&d.eventEdit.fire(d.rendering.id)}),d.deleteButton.mousedown(function(){d.rendering!==undefined&&(d.eventDelete.fire(d.rendering.id),itemDeleted())})}else{var c,e,h,i;c=b.x+b.width,e=b.y-l*4-2,i={x:c+2,y:e+2},h={x:i.x+d.editButton.attr("width")+2,y:e+2},d.menuContainer.attr({x:c,y:e}),d.editButton.attr(i),d.deleteButton.attr(h)}},itemDeleted=function(){d.rendering=undefined,d.itemMenu.hide(),d.svgBBox.hide(),d.handleSet.hide(),d.midDrag.hide()},n=function(b){a.each(d.dirs,function(a,c){var e,f,g;switch(c){case"ul":d.handles.ul===undefined?d.handles.ul={x:b.x,y:b.y,cursor:"nw-resize"}:(f=b.x,g=b.y,d.handles.ul.x=f,d.handles.ul.y=g,e=j.getById(d.handles.ul.id),e.attr({x:f,y:g}));break;case"top":d.handles.top===undefined?d.handles.top={x:b.x+b.width/2,y:b.y,cursor:"n-resize"}:(f=b.x+b.width/2,g=b.y,d.handles.top.x=f,d.handles.top.y=g,e=j.getById(d.handles.top.id),e.attr({x:f,y:g}));break;case"ur":d.handles.ur===undefined?d.handles.ur={x:b.x+(b.width-l),y:b.y,cursor:"ne-resize"}:(f=b.x+(b.width-l),g=b.y,d.handles.ur.x=f,d.handles.ur.y=g,e=j.getById(d.handles.ur.id),e.attr({x:f,y:g}));break;case"rgt":d.handles.rgt===undefined?d.handles.rgt={x:b.x-l+b.width,y:b.y-l+b.height/2,cursor:"e-resize"}:(f=b.x-l+b.width,g=b.y-l+b.height/2,d.handles.rgt.x=f,d.handles.rgt.y=g,e=j.getById(d.handles.rgt.id),e.attr({x:f,y:g}));break;case"lr":d.handles.lr===undefined?d.handles.lr={x:b.x-l+b.width,y:b.y-l+b.width,cursor:"se-resize"}:(f=b.x-l+b.width,g=b.y-l+b.height,d.handles.lr.x=f,d.handles.lr.y=g,e=j.getById(d.handles.lr.id),e.attr({x:f,y:g}));break;case"btm":d.handles.btm===undefined?d.handles.btm={x:b.x+b.width/2,y:b.y-l+b.height,cursor:"s-resize"}:(f=b.x+b.width/2,g=b.y-l+b.height,d.handles.btm.x=f,d.handles.btm.y=g,e=j.getById(d.handles.btm.id),e.attr({x:f,y:g}));break;case"ll":d.handles.ll===undefined?d.handles.ll={x:b.x,y:b.y-l+b.height,cursor:"sw-resize"}:(f=b.x,g=b.y-l+b.height,d.handles.ll.x=f,d.handles.ll.y=g,e=j.getById(d.handles.ll.id),e.attr({x:f,y:g}));break;case"lft":d.handles.lft===undefined?d.handles.lft={x:b.x,y:b.y+b.height/2,cursor:"w-resize"}:(f=b.x,g=b.y+b.height/2,d.handles.lft.x=f,d.handles.lft.y=g,e=j.getById(d.handles.lft.id),e.attr({x:f,y:g}));break;case"mid":d.handles.mid===undefined?d.handles.mid={x:b.x+b.width/2,y:b.y+b.height/2,cursor:"pointer"}:(f=b.x+b.width/2,g=b.y+b.height/2,d.handles.mid.x=f,d.handles.mid.y=g,e=j.getById(d.handles.mid.id),e.attr({x:f,y:g}))}})}};return d},c.Client.StreamingVideo.Controller.annoActiveController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.annoActiveController",c);c=d.options,d.applyBindings=function(c,d){var e,f,g,h,i,j,k;e=c.locate("annotation"),f=c.locate("bodycontent"),g=c.locate("annotations"),j=c.locate("textarea"),i=c.locate("editarea"),k=c.locate("editbutton"),updateButton=c.locate("updatebutton"),h=c.locate("deletebutton"),c.events={},c.events.eventClick=b.initEventFirer(!0,!1),c.events.eventDelete=b.initEventFirer(!0,!1),c.events.eventUpdate=b.initEventFirer(!0,!1),c.renderings={},c.active=!1,editStart=function(){a(i).show(),a(f).hide(),c.active=!0,c.events.eventClick.fire(d.itemId)},editEnd=function(){a(i).hide(),a(f).show(),c.active=!1},editUpdate=function(b){b.preventDefault();var e=a(j).val();c.events.eventUpdate.fire(d.itemId,e),editEnd()},a(k).live("click",function(a){a.preventDefault(),c.active?editEnd():editStart()}),a(updateButton).live("click",editUpdate),a(e).live("click",function(a){c.events.eventClick.fire(d.itemId)})};return d},c.Client.StreamingVideo.Controller.canvasController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.canvasClickController",c);d.options=c,d.applyBindings=function(c,d){var e,f,g,h,i=c.locate("svg"),j=d.closeEnough,k,l,m,n,o,p,q=d.paper,r=a(i).offset(),s=function(a){if(c.curRendering===undefined||a!==c.curRendering.id){var b=c.renderings[a];if(b===undefined){c.event.eventClick.fire(""),c.curRendering=undefined;return!1}c.curRendering=b}},t=function(a){if(c.curRendering===undefined||a!==c.curRendering.id)var b=c.renderings[a]};c.event={},c.event.eventClick=b.initEventFirer(!0,!1),c.renderings={},c.curRendering,c.registerRendering=function(a){c.renderings[a.id]=a,a.eventClickHandle!==undefined&&c.event.eventClick.addListener(a.eventClickHandle),a.shapeIsActive!==undefined&&a.shapeIsActive.addListener(s)},c.removeRendering=function(b){var d={},e;b.eventClickHandle!==undefined&&c.event.eventClick.removeListener(b.eventClickHandle),a.each(c.renderings,function(a,c){a!==b.id&&(d[a]=c)}),c.renderings=a.extend(!0,{},d)},a(i).bind("mousedown",function(b){h="",e=Math.abs(b.pageX-r.left),f=Math.abs(b.pageY-r.top),a.each(c.renderings,function(a,b){g=b.getExtents(),k=Math.abs(e-g.x),l=Math.abs(f-g.y);if(k<=g.width&&l<=g.height){h=b.id;if(c.curRendering===undefined||b.id!==c.curRendering.id)c.curRendering=b,app.setActiveAnnotation(b.id);return!1}}),h.length===0&&c.curRendering!==undefined&&(app.setActiveAnnotation(""),c.curRendering=undefined)})};return d}}(jQuery,MITHGrid,OAC),function(a,b,c){var d,e,f;d=c.Client.StreamingVideo.Controller.canvasController({selectors:{svg:""}}),e=c.Client.StreamingVideo.Controller.annotationEditSelectionGrid({}),f=c.Client.StreamingVideo.Controller.keyBoardListener({selectors:{doc:""}}),b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(a,c){var d=b.Presentation.initPresentation("AnnotationList",a,c);return d},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(c,g){var h=b.Presentation.initPresentation("RaphaelCanvas",c,g),i=a(c).attr("id"),j,k;g.cWidth!==undefined?k=g.cWidth:k=a(c).width(),g.cHeight!==undefined?j=g.cHeight:j=a(c).height(),h.canvas=new Raphael(i,k,j),h.canvasEvents=d.bind(c,{closeEnough:5,paper:h.canvas}),h.editBoundingBox=e.bind(a(c),{paper:h.canvas}),h.keyBoardListener=f.bind(a("body"),{});return h}}(jQuery,MITHGrid,OAC);